% !TEX root = Entwurf_goApp.tex

\section{JSON-RPC: Kommunikation Server \& Client}
Für die Kommunikation zwischen Server und Client benutzen wir JSON-RPC und das HTTP-Protokoll.

\subsection{JSON}
JSON (JavaScript Object Notation) ist ein Datenformat mit welchem man zwar kompakt, aber dennoch lesbar, Daten codieren und über das HTTP-Protokoll austauschen kann.
Zum codieren und decodieren unserer JSON-Strings haben wir uns dazu entschieden org.JSON zu verwenden.
JSON Beispiel:
{
  "ID": "1"
  "method": "create"	
  "UserID": "1234",
  "GroupName": "KIT Mensa",
}

\subsection{RPC}
RPC (Remote Procedure Call) ermöglicht es, Methoden auf einem entfernten Rechner/Server aufzurufen. Wir verwenden es um unser Client-Server-Modell zu implementieren.
Wir rufen vom Client (Android-Smartphone) eine Methode eines Servlets auf dem Server auf, welche dann die Anfrage bearbeiter und eine Antwort zurück schickt.
Welche Methode aufgerufen werden soll, codieren wir in der Anfrage durch Angabe des Methodennamens. Das Servlet kann dadurch den richtigen Methodenaufruf initiieren.
Der Parameter der Methode ist der JSON-String vom Client und der Rückgabewert ist der Antwort-JSON-String, welcher zum Client zurück geschickt wird.


\subsection{HTTP-Protokoll}
Das HTTP-Protokoll beinhaltet verschiedene Anfragemethoden.
Wir verwenden allerdings nur GET und POST, welches die zwei wichtigsten sind und teilen die aufrufbaren Methoden auf diese auf:
1. GET-Requests: Anfragen die nur Daten abfragen ohne dabei Daten zu verändern.
2. POST-Requests: Anfragen die Daten bearbeiten/verändern.

Daher gilt, dass man GET-Requests beliebig oft ausführen kann ohne einen Fehler zu erzeugen, da keine Daten verändert werden.
\newpage
\hypertarget{controler.serverConnection}{}
\hypertarget{ServerConnection}{}
	\subsection{edu.kit.pse.gruppe1.goApp.client.controler.serverConnection}
	 	Nachfolgend werden die Klassen des Paketes ServerConnection näher erläutert.
 	Dieses stellt die Schnittstelle zum Server dar. Das Paket benutzt von org.json die Klassen JSONObject und JSONArray.
 	JSONObject repräsentiert einen JSON-String, hat einen Konstruktor dem man einen JSON-String übergeben kann und besitzt die Methoden get und put um Elemente aus dem JSON-String auszulesen bzw. Elemente einem JSON-String hinzuzufügen.
 	Zusätzlich besteht die Möglichkeit dem Konstruktor ein Objekt zu übergeben, welches dieser dann serialisiert.
 	Ein JSONArray ist eine Menge von Objekten des gleichen Typs welche zu einem JSONObject gehören.
 	
	\subsubsection{public class HTTPConnection}
If a service wants to communicate with the server, the service has to create a HTTPConnection object and must call the sendGet/PostRequest method.
For later requests the service can use the same HTTPConnection object.
\newline 
Attributs:
\begin{itemize}
\item private static final String SERVER{\_}URL
		\begin{description}
		\item URL-adress of the Server
		\end{description}
\end{itemize}
Methods:
\begin{itemize}
	\item public HTTPConnection(String nameOfServlet)
		\begin{description}
		\item Constructor which expects the name of the servlet.
	 \item @param nameOfServlet The name of the servlet, the service wants to communicate with.
		\end{description}
		
		\item public void sendGetRequest(String JSON)
		\begin{description}
\item Method that handles a get request.
	 \item @param JSON The String which should be send to the server.
	 \item @return The JSONObject of the JSON-String which was sent back from the Server.
		\end{description}
		
		\item public void sendPostRequest(String JSON)
		\begin{description}
\item Method that handles a post request.
	 \item @param JSON The String which should be send to the server.
	 \item @return The JSONObject of the JSON-String which was sent back from the Server.
		\end{description}
	\end{itemize}
	\hypertarget{JSONParameter}{}
	\subsubsection{public enum JSONParameter}
Enumeration with all possible parameter-types for the JSON-strings.
	\newline Enum literals:
	\begin{itemize}
	
	\item ID
	\begin{description}
	\item ID of the request.
	\end{description}
	
	 \item ErrorCode
	 \begin{description}
	 \item Error code which is 0 if no error occurred.
	 \end{description}
	 
	 \item UserID
	 \begin{description}
	 \item ID of an user.
	 \end{description}
	 
     \item GroupID
     \begin{description}
	 \item ID of a group.
\end{description}

	\item EventID
	\begin{description}
	\item ID of an event.
\end{description}
	 
	\item UserName
	\begin{description}
	\item Name of an user.
\end{description}

	\item GroupName	
	\begin{description}
	\item Name of a group.
\end{description}
	 
	\item EventName
	\begin{description}
	\item Name of an event.
\end{description}
	 
	\item Method 
	\begin{description}
	\item The name of the method which should be executed on the server. For example the create method of the GroupServlet.
\end{description}

	\item and further ones
\end{itemize}

Methods:
\begin{itemize}
	\item public String toString()
		\begin{description}
		\item Gives the corresponding name to an enum literal. Normally the enum literal name.
		\item @return The corresponding name.
		\end{description}
		
	\item public static JSONParameter fromString(String s)
		\begin{description}
		\item Gives the corresponding enum literal to a string.
	 \item @param s The string to the searched enum literal.
     \item @return The corresponding enum literal.
		\end{description}
\end{itemize}

\hypertarget{servlet}{}
\hypertarget{Servlets}{}
	\subsection{edu.kit.pse.gruppe1.goApp.server.servlet}
	Im Servlet Package liegen die Servlets, welche alle von der Klasse HttpServlet erben.
	Wenn eine Nachricht an den Server geschickt wird, leitet Tomcat die Nachricht an das in der URL angegebene Servlet weiter.
	Dazu ruft es die doGet bzw. doPost Methode bei dem Servlet auf, welche dann den Inhalt der Nachricht ausliest und eine Antwort zurück schicken kann.
	\subsubsection{public enum JSONParameter}
	\hyperlink{JSONParameter}{siehe oben}
\subsubsection{public class EventServlet extends HttpServlet}
This servlet is used to create, view and edit events within a given group.

Methods:
\begin{itemize}
\item private String create(JSONObject json) 
		\begin{description}
\item Any user, that is a member of a group may create an event within this group. The member that 		creates this event will be registered as the event admin. The admin has the right to change 		data about his event. Each member of a group may only be admin of one event within this group.
\item @param json This JSON object contains all information about the new event such as event time, 		location, event name and the user creating this event.
\item @return A JSON string containing the previously created event is returned.
\end{description}

\item private String getEvent(JSONObject json) 
		\begin{description}	
	 \item A method used to access information about an event. Every user, that can see this event may request information about it. Users that are not a member of the group may not view the groups events. Accessible information includes name, location, admin and time.
	  \item @param json A JSON object containing the event about which the information is requested.
	  \item @return A JSON string containing all information about the given event is returned.
\end{description}

 \item	private String change(JSONObject json)
		\begin{description}
	 \item This method may only be invoked by an event admin and he may only change the event, he administrates. He may update all information such as name, location and date. He may also elect a new admin for this event or delete it.
	  \item @param json The JSON object contains an event with the updated information.
	  \item @return A JSON string containing the updated information about the event is returned.
\end{description}
\end{itemize}

\subsubsection{public class RequestSearchServlet extends HttpServlet}
  This servlet returns active requests from a group or a user.
Methods:
\begin{itemize}
\item private String getRequestsByUser(JSONObject json)
	\begin{description}
	\item
	  This method fetches all active join requests from a given user. Only the user himself may view all of his active join requests.
	  \item @param json The JSON object contains the user that is asking for the list of his join requests
	  \item @return Returns a JSON string containing a list of all join requests issued by the given user.
	  \end{description}


\item private String getRequestsByGroup(JSONObject json)
	\begin{description}
	\item
	  This method fetches all active join requests for a given group. Join requests may only be viewed by the group founder.
	  \item @param json The JSON object contains the ID of the group from which the join requests shall be fetched.
	  \item @return Returns a JSON string containing a list of all active join requests for the given group.
	  \end{description}
		  \end{itemize}  
\subsubsection{public class RequestServlet extends HttpServlet}	  
	   Methods in this class exist so that a user can request to join a group and the group founder may then accept or reject the join request.

 Methods:
\begin{itemize}
	 \item private String create(JSONObject json)
		\begin{description}
	 \item This method creates a join request from a user to a group. The user may not have reached the group limit already and the group may not have reached the user limit. Also the user may not already be a member of this group.
	 \item @param json The JSON Object contains the user that posts the join request and the ID of the group the request is posted to.
	 \item @return Returns a JSON string containing information about the success of this operation.
	  \end{description}
	 

	
	\item private String accept(JSONObject json)
	\begin{description}
	 \item This method accepts a users join request. Only a group founder may accept join requests. After a request has been accepted, the user is a new member of the group and the request is no longer valid.
	 \item @param json The JSON object contains the request that is to be accepted.
	 \item @return Returns a JSON string containing information about the success of this operation.
	  \end{description}
	
	\item private String reject(JSONObject json)
	\begin{description}
	 \item This method rejects a users join request. Only a group founder may reject join requests. After a request has been rejected it is no longer valid.
	 \item @param json The JSON object contains the request that is to be rejected.
	 \item @return Returns a JSON string containing information about the success of this operation.
	  \end{description}
\end{itemize}	                              
	
	\subsubsection{public class LoginServlet extends HttpServlet}
This servlet is used to register users that start the app for the first time and login returning users.
 


	
	 Methods:
\begin{itemize}
\item private String register(JSONObject json) 
\begin{description}
	 \item Invoking this method creates a new user and registers his ID to the database. The new user may then join groups. A user can register only once, if he returns to the app he must use the login function.
	 \item @param json The JSON object contains a user ID to which the user shall be registered.
	 \item @return Returns a JSON string containing the user that just registered.
	 \end{description}

\item private String login(JSONObject json)
\begin{description}
	 \item If a user has already registered to the database but his client is currently not logged in, he can call this method to regain access to the functions of this app. A user may only login if he isn't already logged in and has registered himself previously at any point.
	 \item @param json This JSON object contains the user that wants to login.
	 \item @return Returns a JSON string containing the user that just logged in.
	
	\end{description}
	\end{itemize}
	
	
	\subsubsection{public class LocationServlet extends HttpServlet}
	 This servlet can be used by event participants to update their location and view the current clustered location of other participants that are on the move.
	 
	 Methods:
		 \begin{itemize}

\item private String setGPS(JSONObject json)
\begin{description}	
	 \item A user may update his current gps location if his status is "go" for at least one event. The updated gps location will be used for the next clustering to update the groups location.
	 \item @param json The JSON object must contain the next location of the user.
	 \item @return Returns a JSON string containing information about the success of this operation.
	\end{description}	
	
	\item private String getCluster(JSONObject json)
	\begin{description}
	 \item A user that participates in an event may request the clustered locations of all other participants whose status is set to "go" if his own status is also set to "go" for this specific event.
	 \item @param json The JSON object contains the event for which the user requests the cluster.
	 \item @return Returns a JSON string containing the results of the clustering algorithm.
	 
	\end{description}
	\end{itemize}
	
	
	\subsubsection{public class GroupSearchServlet extends HttpServlet}
	This servlet offers methods to search for groups with a specific name or in which a given user is the member.

	 Methods:
		 \begin{itemize}
	\item private String getGroupsByName(JSONObject json)
\begin{description}
	 \item Searches for all groups whose name begins with the given string.
	 \item @param json The JSON object contains the string that is searched for in the groups names.
	 \item @return Returns a JSON string containing a list of all the groups associated with this name.
	 
	\end{description}

\item private String getGroupsByMember(JSONObject json)
	\begin{description}	
	 \item Searches for all groups the given user is a member of.
	 \item @param json The JSON object contains the user that is a member in the groups searched for.
	 \item @return Returns a JSON string containing a list of all the groups in which the given user is a member.
	 
	\end{description}
	\end{itemize}
	
	\subsubsection{public class GoServlet extends HttpServlet}
	This servlets functions revolve around the go button and allow users to signal they started approaching the events location and view the status of other participants in this event.
	
	 Methods:
		 \begin{itemize}
\item private String getStartedParticpants(JSONObject json)
\begin{description}
	 \item A participant that has previously set his status to "go" may request a list of fellow participants that are also on the way.
	 \item @param json JSON object containing the event the participant list is requested for.
	 \item @return Returns a JSON string containing a list with all participants of this event that have set their status to "go".
	 
	\end{description}

\item private String setStarted(JSONObject json)
	\begin{description}
	 \item Allows the participant of an event to set his status to "go" which enables position tracking and viewing of other participants positions. The participant must have previously accepted the invitation to this event.
	 \item @param json The JSON object contains the user that updates his status and the event he updates it for.
	 \item @return Returns a JSON string containing information about the success of this operation.
	 
	\end{description}
	\end{itemize}
	
	\subsubsection{public class UserServlet extends HttpServlet}
	This servlet is used by users to access and manage information about them.

	 Methods:
		 \begin{itemize}
\item private String changeName(JSONObject json)
\begin{description}
	 \item This method allows a user to change his name to a string value of his choice. A user may only change his own name.
	 \item @param json The JSON object contains the user that wants to change his name and the string with the name the user wants to change it to.
	 \item @return Returns a JSON string containing information about the success of this operation.
	 
	\end{description}
	 
	 \item private String getUser(JSONObject json)
	\begin{description}	
	 \item A user can invoke this to retrieve any information about a given user such as groups he is a member of and events he wants to participate or is invited to.
	 \item @param json This JSON object contains the user about whom the information shall be released.
	 \item @return Returns a JSON string containing information about the success of this operation.
	  
	\end{description}
	\end{itemize}
	
	\subsubsection{public class ParticipateServlet extends HttpServlet}
	Users can access methods in this servlet to indicate whether they want to participate in an event from the group.
	
	 Methods:
		 \begin{itemize}
\item private String accept(JSONObject json)
\begin{description}
	 \item A user may accept an invitation to any event in a group he is a member of. He may accept or reject any event only once and can not invoke any of these two methods again later on for the same event.
	 \item @param json A JSON object that contains the user wanting to accept the invite and the event he wants to participate in.
	 \item @return Returns a JSON string containing information about the success of this operation.
	 \end{description}
	 
	 \item private String reject(JSONObject json)
	\begin{description}	
	 \item A user may reject an invitation to any event in a group he is a member of. He may accept or reject any event only once and can not invoke any of these two methods again later on for the same event.
	 \item @param json A JSON object that contains the user wanting to decline the invite and the event he wants to abstain from.
	 \item @return Returns a JSON string containing information about the success of this operation.
	 \end{description}
	\end{itemize}
	
	\subsubsection{public class GroupServlet extends HttpServlet}	
 This servlet contains all methods to create, manipulate and delete groups. 

 Methods:
	 \begin{itemize}
	 \item private String create(JSONObject json)
	 \begin{description}
	 \item This method creates a new group. A user can create a new group if has not yet reached the group limit. By creating a group, his group count is incremented by one. He is also registered as the groups founder.
	 \item @param json This JSON objects contains information about the group that is to be created such as the name and the founding member.
	 \item @return Returns a JSON string containing the ID of the created group.
			 \end{description}
	
	 \item private String delete(JSONObject json)
	 \begin{description}
	 \item This method may be called by a founder to delete his group. The group will be removed from the database as well as all events and the users are removed from this group. The group count of all users in this group is reduced by one.
	 \item @param json JSON object containing the ID of the group that is to be deleted.
	 \item @return Returns a JSON string containing information about the success of this operation.
			 \end{description}
	
	 \item private String setName(JSONObject json)
	 \begin{description}
	 \item This method may change the name of a given group. Only a groups founder may change its name.
	 \item @param json JSON object containing the ID of the group on which the name change shall be executed and the new name of the group in a string.
	 \item @return Returns a JSON string containing information about the success of this operation.
			 \end{description}
	
	 \item private String deleteMember(JSONObject json)
	 \begin{description}
	 \item A founder may call this method in order to remove members from his group. They will also be removed from all events in this group and their group count is decremented by one.
	 \item @param json JSON object containing the ID of the group from which the member shall be removed and the user that should be removed.
	 \item @return Returns a JSON string containing information about the success of this operation.
			 \end{description}
	
	 \item private String getEvents(JSONObject json)
	 \begin{description}
	 \item Any user may request a list of events from any group he is a member of.
	 \item @param json JSON object containing the ID of the group from which the events are requested.
	 \item @return Returns a JSON string containing a list with all Events within that group.
			 \end{description}
	
	 \item private String getGroup(JSONObject json)
	 \begin{description}
	 \item This method returns all relevant information about a given group and may be invoked by any member of that group.
	 \item @param json JSON object containing the ID of the group about which the information is requested.
	 \item @return Returns a JSON string containing information about the group such as members, events, the founder and users that have sent unanswered requests to this group.
			 \end{description}
	

	 
	 \item private String setFounder(JSONObject json)
	 \begin{description}
	 \item If a founder wishes to resign, he can call this method to transfer his rights to another user. Only a founder may invoke this method on his group. If a founder leaves his group this method is called automatically. Only a user that is currently a member in this group may be elected as the new groups founder.
	 \item @param json JSON object containing the ID of the group whose founder shall be changed and the member of the group that is to become the founder.
	 \item @return Returns a JSON string containing information about the success of this operation.
			 \end{description}
		\end{itemize}	
	\newpage